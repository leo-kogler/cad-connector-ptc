/***
 *              _____                    _____                    _____                    _____             _____                    _____                    _____                    _____             _____                        
 *             /\    \                  /\    \                  /\    \                  /\    \           /\    \                  /\    \                  /\    \                  /\    \           /\    \                       
 *            /::\    \                /::\____\                /::\    \                /::\    \         /::\    \                /::\    \                /::\    \                /::\    \         /::\    \                      
 *           /::::\    \              /::::|   |               /::::\    \              /::::\    \        \:::\    \              /::::\    \              /::::\    \              /::::\    \        \:::\    \                     
 *          /::::::\    \            /:::::|   |              /::::::\    \            /::::::\    \        \:::\    \            /::::::\    \            /::::::\    \            /::::::\    \        \:::\    \                    
 *         /:::/\:::\    \          /::::::|   |             /:::/\:::\    \          /:::/\:::\    \        \:::\    \          /:::/\:::\    \          /:::/\:::\    \          /:::/\:::\    \        \:::\    \                   
 *        /:::/__\:::\    \        /:::/|::|   |            /:::/__\:::\    \        /:::/__\:::\    \        \:::\    \        /:::/__\:::\    \        /:::/__\:::\    \        /:::/__\:::\    \        \:::\    \                  
 *        \:::\   \:::\    \      /:::/ |::|   |           /::::\   \:::\    \      /::::\   \:::\    \       /::::\    \      /::::\   \:::\    \      /::::\   \:::\    \      /::::\   \:::\    \       /::::\    \                 
 *      ___\:::\   \:::\    \    /:::/  |::|___|______    /::::::\   \:::\    \    /::::::\   \:::\    \     /::::::\    \    /::::::\   \:::\    \    /::::::\   \:::\    \    /::::::\   \:::\    \     /::::::\    \                
 *     /\   \:::\   \:::\    \  /:::/   |::::::::\    \  /:::/\:::\   \:::\    \  /:::/\:::\   \:::\____\   /:::/\:::\    \  /:::/\:::\   \:::\____\  /:::/\:::\   \:::\    \  /:::/\:::\   \:::\____\   /:::/\:::\    \               
 *    /::\   \:::\   \:::\____\/:::/    |:::::::::\____\/:::/  \:::\   \:::\____\/:::/  \:::\   \:::|    | /:::/  \:::\____\/:::/  \:::\   \:::|    |/:::/  \:::\   \:::\____\/:::/  \:::\   \:::|    | /:::/  \:::\____\              
 *    \:::\   \:::\   \::/    /\::/    / ~~~~~/:::/    /\::/    \:::\  /:::/    /\::/   |::::\  /:::|____|/:::/    \::/    /\::/    \:::\  /:::|____|\::/    \:::\  /:::/    /\::/   |::::\  /:::|____|/:::/    \::/    /              
 *     \:::\   \:::\   \/____/  \/____/      /:::/    /  \/____/ \:::\/:::/    /  \/____|:::::\/:::/    //:::/    / \/____/  \/_____/\:::\/:::/    /  \/____/ \:::\/:::/    /  \/____|:::::\/:::/    //:::/    / \/____/               
 *      \:::\   \:::\    \                  /:::/    /            \::::::/    /         |:::::::::/    //:::/    /                    \::::::/    /            \::::::/    /         |:::::::::/    //:::/    /                        
 *       \:::\   \:::\____\                /:::/    /              \::::/    /          |::|\::::/    //:::/    /                      \::::/    /              \::::/    /          |::|\::::/    //:::/    /                         
 *        \:::\  /:::/    /               /:::/    /               /:::/    /           |::| \::/____/ \::/    /                        \::/____/               /:::/    /           |::| \::/____/ \::/    /                          
 *         \:::\/:::/    /               /:::/    /               /:::/    /            |::|  ~|        \/____/                          ~~                    /:::/    /            |::|  ~|        \/____/                           
 *          \::::::/    /               /:::/    /               /:::/    /             |::|   |                                                              /:::/    /             |::|   |                                          
 *           \::::/    /               /:::/    /               /:::/    /              \::|   |                                                             /:::/    /              \::|   |                                          
 *            \::/    /                \::/    /                \::/    /                \:|   |                                                             \::/    /                \:|   |                                          
 *             \/____/                  \/____/                  \/____/                  \|___|                                                              \/____/                  \|___|                                          
 *                                                                                                                                                                                                                                     
 *                                                                                                                                                                                                                                     
 *                                                                                                                                                                                                                                     
 *     
 *     ________      ___    ___                                                          
 *    |\   __  \    |\  \  /  /|                                                         
 *    \ \  \|\ /_   \ \  \/  / /                                                         
 *     \ \   __  \   \ \    / /                                                          
 *      \ \  \|\  \   \/  /  /                                                           
 *       \ \_______\__/  / /                                                             
 *        \|_______|\___/ /                                                              
 *                 \|___|/                                                               
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *     ________ ________  ___  _______   ________  ________  ___  ________  ___  ___     
 *    |\  _____\\   __  \|\  \|\  ___ \ |\   ___ \|\   __  \|\  \|\   ____\|\  \|\  \    
 *    \ \  \__/\ \  \|\  \ \  \ \   __/|\ \  \_|\ \ \  \|\  \ \  \ \  \___|\ \  \\\  \   
 *     \ \   __\\ \   _  _\ \  \ \  \_|/_\ \  \ \\ \ \   _  _\ \  \ \  \    \ \   __  \  
 *      \ \  \_| \ \  \\  \\ \  \ \  \_|\ \ \  \_\\ \ \  \\  \\ \  \ \  \____\ \  \ \  \ 
 *       \ \__\   \ \__\\ _\\ \__\ \_______\ \_______\ \__\\ _\\ \__\ \_______\ \__\ \__\
 *        \|__|    \|__|\|__|\|__|\|_______|\|_______|\|__|\|__|\|__|\|_______|\|__|\|__|
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *     ________  _______       ___    ___ _______   ________                             
 *    |\   ____\|\  ___ \     |\  \  /  /|\  ___ \ |\   __  \                            
 *    \ \  \___|\ \   __/|    \ \  \/  / | \   __/|\ \  \|\  \                           
 *     \ \  \  __\ \  \_|/__   \ \    / / \ \  \_|/_\ \   _  _\                          
 *      \ \  \|\  \ \  \_|\ \   \/  /  /   \ \  \_|\ \ \  \\  \|                         
 *       \ \_______\ \_______\__/  / /      \ \_______\ \__\\ _\                         
 *        \|_______|\|_______|\___/ /        \|_______|\|__|\|__|                        
 *                           \|___|/                                                     
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *     ___       _______   ________  ________  ________  ___       ________              
 *    |\  \     |\  ___ \ |\   __  \|\   __  \|\   __  \|\  \     |\   ___ \             
 *    \ \  \    \ \   __/|\ \  \|\  \ \  \|\  \ \  \|\  \ \  \    \ \  \_|\ \            
 *     \ \  \    \ \  \_|/_\ \  \\\  \ \   ____\ \  \\\  \ \  \    \ \  \ \\ \           
 *      \ \  \____\ \  \_|\ \ \  \\\  \ \  \___|\ \  \\\  \ \  \____\ \  \_\\ \          
 *       \ \_______\ \_______\ \_______\ \__\    \ \_______\ \_______\ \_______\         
 *        \|_______|\|_______|\|_______|\|__|     \|_______|\|_______|\|_______|         
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *     ___  __    ________  ________  ___       _______   ________                       
 *    |\  \|\  \ |\   __  \|\   ____\|\  \     |\  ___ \ |\   __  \                      
 *    \ \  \/  /|\ \  \|\  \ \  \___|\ \  \    \ \   __/|\ \  \|\  \                     
 *     \ \   ___  \ \  \\\  \ \  \  __\ \  \    \ \  \_|/_\ \   _  _\                    
 *      \ \  \\ \  \ \  \\\  \ \  \|\  \ \  \____\ \  \_|\ \ \  \\  \|                   
 *       \ \__\\ \__\ \_______\ \_______\ \_______\ \_______\ \__\\ _\                   
 *        \|__| \|__|\|_______|\|_______|\|_______|\|_______|\|__|\|__|                  
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *     ________  ________  ________  _______   ________          ________  ________      
 *    |\   __  \|\   __  \|\   ____\|\  ___ \ |\   ___ \        |\   __  \|\   ___  \    
 *    \ \  \|\ /\ \  \|\  \ \  \___|\ \   __/|\ \  \_|\ \       \ \  \|\  \ \  \\ \  \   
 *     \ \   __  \ \   __  \ \_____  \ \  \_|/_\ \  \ \\ \       \ \  \\\  \ \  \\ \  \  
 *      \ \  \|\  \ \  \ \  \|____|\  \ \  \_|\ \ \  \_\\ \       \ \  \\\  \ \  \\ \  \ 
 *       \ \_______\ \__\ \__\____\_\  \ \_______\ \_______\       \ \_______\ \__\\ \__\
 *        \|_______|\|__|\|__|\_________\|_______|\|_______|        \|_______|\|__| \|__|
 *                           \|_________|                                                
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *     ________  ________  _______           ________    _____   ________                
 *    |\   __  \|\   ____\|\  ___ \         |\   __  \  / __  \ |\_____  \               
 *    \ \  \|\  \ \  \___|\ \   __/|        \ \  \|\  \|\/_|\  \ \|___/  /|              
 *     \ \  \\\  \ \  \    \ \  \_|/__       \ \  \\\  \|/ \ \  \    /  / /              
 *      \ \  \\\  \ \  \____\ \  \_|\ \       \ \  \\\  \ __\ \  \  /  / /               
 *       \ \_______\ \_______\ \_______\       \ \_______\\__\ \__\/__/ /                
 *        \|_______|\|_______|\|_______|        \|_______\|__|\|__||__|/                 
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *        ___  ________  ________  _______                                               
 *       |\  \|\   ____\|\   __  \|\  ___ \                                              
 *       \ \  \ \  \___|\ \  \|\  \ \   __/|                                             
 *     __ \ \  \ \  \    \ \   __  \ \  \_|/__                                           
 *    |\  \\_\  \ \  \____\ \  \ \  \ \  \_|\ \                                          
 *    \ \________\ \_______\ \__\ \__\ \_______\                                         
 *     \|________|\|_______|\|__|\|__|\|_______|                                         
 *                                                                                       
 *    2016
 */
package at.smartpart.listeners;

import java.awt.BorderLayout;
import java.awt.Dimension;
import java.awt.Font;
import java.awt.event.ActionListener;
import java.io.IOException;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

import javax.swing.BoxLayout;
import javax.swing.JButton;
import javax.swing.JDialog;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTable;
import javax.swing.JTextField;
import javax.swing.ListSelectionModel;
import javax.swing.SwingUtilities;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.table.DefaultTableModel;

import com.ptc.cipjava.jxthrowable;
import com.ptc.pfc.pfcCommand.DefaultUICommandActionListener;
import com.ptc.pfc.pfcGlobal.pfcGlobal;
import com.ptc.pfc.pfcSession.Session;

import at.smartpart.Workbench;
import at.smartpart.beans.CadPart;
import at.smartpart.transfer.FetchSolids;

public class DownloadListener extends DefaultUICommandActionListener {

	private Session session;
	static List<String> toUpload = new ArrayList<String>();
	Object[][] data = new Object[2][2];
	DefaultTableModel tModel;
	JDialog jDialog = new JDialog();
	boolean firsRunt = true;
	protected JFrame membersDialog = new JFrame();
	JPanel panel = new JPanel();
	JTable table;
	private boolean firstRun = true;
	JButton btnFetch;
	List<CadPart> curVersionsTable = new ArrayList<CadPart>();
	private List<String> members = new ArrayList<String>();
	private JButton btnSearch;
	Object[] colums = { "Filename", "local Version", "current Version", "new Version" };
	int selectedRow = -1;
	boolean ALLOW_ROW_SELECTION = true;
	String prt_number ="";
	int version = -1;
	Font font;

	@Override
	public void OnCommand() throws jxthrowable {
		Session session = pfcGlobal.GetProESession();
		com.ptc.pfc.pfcDisplay.Font ptcFont = session.GetDefaultFont();
		String defFontName = ptcFont.GetName();
		font = new Font(defFontName, 1, 25);
		
	
		try {
			
			Workbench.setWorkDir(session.GetCurrentDirectory());
		} catch (jxthrowable e1) {
			e1.printStackTrace();
			System.out.println(e1.toString());
		}

		// Search () textfield + button

		// query result into table

		createBaseWindow();

		// fetching jtree and traverse

	}

	private void createBaseWindow() {
		
		panel.removeAll();
		
		data = new Object[curVersionsTable.size()][2];

		Dimension dim = new Dimension(1000, 600);

		for (int i = 0; i < curVersionsTable.size(); i++) {

			CadPart cadPart = curVersionsTable.get(i);

			// System.out.println("in loop " + i + " " + cadPart.getFileName());

			Object[] rowData = { cadPart.getFileName(), cadPart.getLocalVersion(), cadPart.getCurDbVersion(),
					cadPart.getNextVersion() };

			data[i] = rowData;

		}

		// System.out.println(data.toString());

		//panel = new JPanel();

		if (firstRun) {
			tModel = new DefaultTableModel(data, colums);
			table = new JTable(tModel);
		}
		if (!firstRun) {
			DefaultTableModel model2 = (DefaultTableModel) table.getModel();
			model2.setDataVector(data, colums);
			table = new JTable(model2);
		}

		firstRun = false;

		tModel.fireTableDataChanged();

		table.setRowSelectionAllowed(true);
		ListSelectionModel rowSelModel = table.getSelectionModel();
		rowSelModel.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);

		table.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
		if (ALLOW_ROW_SELECTION) { // true by default
			ListSelectionModel rowSM = table.getSelectionModel();
			rowSM.addListSelectionListener(new ListSelectionListener() {
				public void valueChanged(ListSelectionEvent e) {
					// Ignore extra messages.
					if (e.getValueIsAdjusting())
						return;

					ListSelectionModel lsm = (ListSelectionModel) e.getSource();
					if (lsm.isSelectionEmpty()) {
						System.out.println("No rows are selected.");
					} else {
						int selectedRow = lsm.getMinSelectionIndex();
						System.out.println("Row " + selectedRow + " is now selected.");
						
						prt_number = table.getValueAt(selectedRow, 0).toString();

						Object ver = table.getValueAt(selectedRow, 2);
						version = Integer.parseInt(ver.toString());
						
						System.out.println("Filename:" + prt_number + " version: " + version);
	
					}
				}
			});
		} else {
			table.setRowSelectionAllowed(false);
		}

		table.setFont(font);
		table.setRowHeight(font.getSize() + 10);

		table.setAutoCreateColumnsFromModel(true);
		// table.tableChanged(null);

		JScrollPane jsp = new JScrollPane(table);
		table.invalidate();
		table.setSize(dim);
		table.repaint();
		jsp.invalidate();
		jsp.repaint();

		btnFetch = new JButton("Download");
		btnFetch.addActionListener(new ActionListener() {
			public void actionPerformed(java.awt.event.ActionEvent e) {

				// Set working Dir
				/*
				 * JFileChooser chooser = new JFileChooser();
				 * chooser.setCurrentDirectory(new File("."));
				 * chooser.setDialogTitle("select working directory");
				 * chooser.setFileSelectionMode(JFileChooser.DIRECTORIES_ONLY);
				 * chooser.setAcceptAllFileFilterUsed(false);
				 * 
				 * File file = chooser.getCurrentDirectory(); String path =
				 * file.getAbsolutePath();
				 * 
				 * Workbench.setWorkDir(path);
				 */
				new Thread() {

					public void run() {

						printDebugData(table);
						
						DownloadMetaData meta = new DownloadMetaData();
						
						System.out.println("prt_number" + prt_number + " version " +version);
						
						CadPart cadPart = meta.queryAsm(prt_number, version);
						JTreeTraversal treeTrav = new JTreeTraversal(cadPart.getJTree());
						members = treeTrav.getMembers();

						new Thread() {

							public void run() {

								
								for(String fn : members) {
									System.out.println("members: " + fn);
								}
								
								FetchSolids fs = new FetchSolids();
								boolean success = false;
								try {
									success = fs.queryForSolid(members);
								} catch (SQLException e1) {
									// TODO Auto-generated catch block
									e1.printStackTrace();
								} catch (IOException e1) {
									// TODO Auto-generated catch block
									e1.printStackTrace();
								}
								if (success) {
									JDialog jDialog = new JDialog();
									JLabel lblSuccess = new JLabel("download finished successfully");
									JButton btnQuit = new JButton("quit");

									btnQuit.addActionListener(new ActionListener() {
										public void actionPerformed(java.awt.event.ActionEvent e) {
											jDialog.dispose();
										}
									});

									JPanel panel = new JPanel();
									panel.add(lblSuccess);
									panel.add(btnQuit);
									panel.setPreferredSize(dim);
									panel.setVisible(true);
									jDialog.add(panel);
									jDialog.setVisible(true);
									jDialog.pack();

								}

							}

						}.start();

						try {
							fadeOut();
						} catch (jxthrowable e) {

							e.printStackTrace();
							System.out.println(e.toString());
						}

						// traverse.clearAll();
						// subTrav.clearAll();
						curVersionsTable.clear();

					}

				}.start();

			}
		});

		btnSearch = new JButton("search");
		btnSearch.addActionListener(new ActionListener() {
			public void actionPerformed(java.awt.event.ActionEvent e) {

				jDialog = createSearchDialog();
				jDialog.setVisible(true);
				jDialog.setAlwaysOnTop(true);

				System.out.println("created dialog.");

			}
		});

		// Dimension dim2 = new Dimension(600, 400);
		jsp.setVisible(true);
		jsp.repaint();
		jsp.invalidate();
		panel.setLayout(new BoxLayout(panel, BoxLayout.Y_AXIS));
		JPanel hpanel = new JPanel();
		hpanel.setLayout(new BoxLayout(hpanel, BoxLayout.X_AXIS));
		panel.add(jsp);// , BorderLayout.CENTER);
		panel.add(hpanel);
		table.setVisible(true);
		hpanel.add(btnFetch);
		hpanel.add(btnSearch);
		panel.setSize(990, 590);
		panel.setVisible(true);
		membersDialog.getContentPane().add(panel);
		membersDialog.repaint();
		membersDialog.setSize(dim);
		membersDialog.setAlwaysOnTop(true);
		membersDialog.setVisible(true);
		
		


		

	}

	// geometry into new working dir

	private JDialog createSearchDialog() {
		Dimension dim = new Dimension(250, 50);
		JDialog jDialog = new JDialog();
		JPanel panel = new JPanel();
		JTextField tf = new JTextField();
		tf.setPreferredSize(dim);
		//JCheckBox chbx = new JCheckBox("query for asm ?");

		JButton btnConfirm = new JButton("Query");
		btnConfirm.setPreferredSize(dim);
		btnConfirm.addActionListener(new ActionListener() {
			public void actionPerformed(java.awt.event.ActionEvent e) {

				new Thread() {
					public void run() {

						QueryForPrecence precence = new QueryForPrecence();
						String prt_number = tf.getText();

						if (prt_number.contains("asm")) {
							curVersionsTable = precence.query(prt_number, "asm");
						} else {
							curVersionsTable = precence.query(prt_number, "prt");
						}

						createBaseWindow();

					}

				}.start();

				jDialog.setVisible(false);
				// jDialog.dispose();

			}
		});

		panel.add(tf, BorderLayout.NORTH);
		panel.add(btnConfirm, BorderLayout.SOUTH);
		panel.setSize(1000, 600);
		panel.setVisible(true);
		jDialog.add(panel, BorderLayout.CENTER);
		//jDialog.add(chbx, BorderLayout.SOUTH);
		jDialog.pack();
		jDialog.setVisible(true);

		return jDialog;
	}

	public static List<String> getList() {
		return toUpload;
	}

	void fadeOut() throws jxthrowable {

		Runnable edt = new Runnable() {
			public void run() {
				membersDialog.setVisible(false);

				clearArray(data);

				membersDialog.removeAll();

				// membersDialog.repaint();

			}
		};
		SwingUtilities.invokeLater(edt);

	}
	
	
	  private void printDebugData(JTable table) {
		    int numRows = table.getRowCount();
		    int numCols = table.getColumnCount();
		    javax.swing.table.TableModel model = table.getModel();

		    System.out.println("Value of data: ");
		    for (int i = 0; i < numRows; i++) {
		      System.out.print("    row " + i + ":");
		      for (int j = 0; j < numCols; j++) {
		        System.out.print("  " + model.getValueAt(i, j));
		      }
		      System.out.println();
		    }
		    System.out.println("--------------------------");
		  }

	private void clearArray(Object[][] data2) {

		for (int i = 0; i < data2.length; i++) {
			for (int j = 0; j < data2.length; j++) {
				data2[i][j] = "";
			}
		}

	}
}