/***
 *              _____                    _____                    _____                    _____             _____                    _____                    _____                    _____             _____                        
 *             /\    \                  /\    \                  /\    \                  /\    \           /\    \                  /\    \                  /\    \                  /\    \           /\    \                       
 *            /::\    \                /::\____\                /::\    \                /::\    \         /::\    \                /::\    \                /::\    \                /::\    \         /::\    \                      
 *           /::::\    \              /::::|   |               /::::\    \              /::::\    \        \:::\    \              /::::\    \              /::::\    \              /::::\    \        \:::\    \                     
 *          /::::::\    \            /:::::|   |              /::::::\    \            /::::::\    \        \:::\    \            /::::::\    \            /::::::\    \            /::::::\    \        \:::\    \                    
 *         /:::/\:::\    \          /::::::|   |             /:::/\:::\    \          /:::/\:::\    \        \:::\    \          /:::/\:::\    \          /:::/\:::\    \          /:::/\:::\    \        \:::\    \                   
 *        /:::/__\:::\    \        /:::/|::|   |            /:::/__\:::\    \        /:::/__\:::\    \        \:::\    \        /:::/__\:::\    \        /:::/__\:::\    \        /:::/__\:::\    \        \:::\    \                  
 *        \:::\   \:::\    \      /:::/ |::|   |           /::::\   \:::\    \      /::::\   \:::\    \       /::::\    \      /::::\   \:::\    \      /::::\   \:::\    \      /::::\   \:::\    \       /::::\    \                 
 *      ___\:::\   \:::\    \    /:::/  |::|___|______    /::::::\   \:::\    \    /::::::\   \:::\    \     /::::::\    \    /::::::\   \:::\    \    /::::::\   \:::\    \    /::::::\   \:::\    \     /::::::\    \                
 *     /\   \:::\   \:::\    \  /:::/   |::::::::\    \  /:::/\:::\   \:::\    \  /:::/\:::\   \:::\____\   /:::/\:::\    \  /:::/\:::\   \:::\____\  /:::/\:::\   \:::\    \  /:::/\:::\   \:::\____\   /:::/\:::\    \               
 *    /::\   \:::\   \:::\____\/:::/    |:::::::::\____\/:::/  \:::\   \:::\____\/:::/  \:::\   \:::|    | /:::/  \:::\____\/:::/  \:::\   \:::|    |/:::/  \:::\   \:::\____\/:::/  \:::\   \:::|    | /:::/  \:::\____\              
 *    \:::\   \:::\   \::/    /\::/    / ~~~~~/:::/    /\::/    \:::\  /:::/    /\::/   |::::\  /:::|____|/:::/    \::/    /\::/    \:::\  /:::|____|\::/    \:::\  /:::/    /\::/   |::::\  /:::|____|/:::/    \::/    /              
 *     \:::\   \:::\   \/____/  \/____/      /:::/    /  \/____/ \:::\/:::/    /  \/____|:::::\/:::/    //:::/    / \/____/  \/_____/\:::\/:::/    /  \/____/ \:::\/:::/    /  \/____|:::::\/:::/    //:::/    / \/____/               
 *      \:::\   \:::\    \                  /:::/    /            \::::::/    /         |:::::::::/    //:::/    /                    \::::::/    /            \::::::/    /         |:::::::::/    //:::/    /                        
 *       \:::\   \:::\____\                /:::/    /              \::::/    /          |::|\::::/    //:::/    /                      \::::/    /              \::::/    /          |::|\::::/    //:::/    /                         
 *        \:::\  /:::/    /               /:::/    /               /:::/    /           |::| \::/____/ \::/    /                        \::/____/               /:::/    /           |::| \::/____/ \::/    /                          
 *         \:::\/:::/    /               /:::/    /               /:::/    /            |::|  ~|        \/____/                          ~~                    /:::/    /            |::|  ~|        \/____/                           
 *          \::::::/    /               /:::/    /               /:::/    /             |::|   |                                                              /:::/    /             |::|   |                                          
 *           \::::/    /               /:::/    /               /:::/    /              \::|   |                                                             /:::/    /              \::|   |                                          
 *            \::/    /                \::/    /                \::/    /                \:|   |                                                             \::/    /                \:|   |                                          
 *             \/____/                  \/____/                  \/____/                  \|___|                                                              \/____/                  \|___|                                          
 *                                                                                                                                                                                                                                     
 *                                                                                                                                                                                                                                     
 *                                                                                                                                                                                                                                     
 *     
 *     ________      ___    ___                                                          
 *    |\   __  \    |\  \  /  /|                                                         
 *    \ \  \|\ /_   \ \  \/  / /                                                         
 *     \ \   __  \   \ \    / /                                                          
 *      \ \  \|\  \   \/  /  /                                                           
 *       \ \_______\__/  / /                                                             
 *        \|_______|\___/ /                                                              
 *                 \|___|/                                                               
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *     ________ ________  ___  _______   ________  ________  ___  ________  ___  ___     
 *    |\  _____\\   __  \|\  \|\  ___ \ |\   ___ \|\   __  \|\  \|\   ____\|\  \|\  \    
 *    \ \  \__/\ \  \|\  \ \  \ \   __/|\ \  \_|\ \ \  \|\  \ \  \ \  \___|\ \  \\\  \   
 *     \ \   __\\ \   _  _\ \  \ \  \_|/_\ \  \ \\ \ \   _  _\ \  \ \  \    \ \   __  \  
 *      \ \  \_| \ \  \\  \\ \  \ \  \_|\ \ \  \_\\ \ \  \\  \\ \  \ \  \____\ \  \ \  \ 
 *       \ \__\   \ \__\\ _\\ \__\ \_______\ \_______\ \__\\ _\\ \__\ \_______\ \__\ \__\
 *        \|__|    \|__|\|__|\|__|\|_______|\|_______|\|__|\|__|\|__|\|_______|\|__|\|__|
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *     ________  _______       ___    ___ _______   ________                             
 *    |\   ____\|\  ___ \     |\  \  /  /|\  ___ \ |\   __  \                            
 *    \ \  \___|\ \   __/|    \ \  \/  / | \   __/|\ \  \|\  \                           
 *     \ \  \  __\ \  \_|/__   \ \    / / \ \  \_|/_\ \   _  _\                          
 *      \ \  \|\  \ \  \_|\ \   \/  /  /   \ \  \_|\ \ \  \\  \|                         
 *       \ \_______\ \_______\__/  / /      \ \_______\ \__\\ _\                         
 *        \|_______|\|_______|\___/ /        \|_______|\|__|\|__|                        
 *                           \|___|/                                                     
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *     ___       _______   ________  ________  ________  ___       ________              
 *    |\  \     |\  ___ \ |\   __  \|\   __  \|\   __  \|\  \     |\   ___ \             
 *    \ \  \    \ \   __/|\ \  \|\  \ \  \|\  \ \  \|\  \ \  \    \ \  \_|\ \            
 *     \ \  \    \ \  \_|/_\ \  \\\  \ \   ____\ \  \\\  \ \  \    \ \  \ \\ \           
 *      \ \  \____\ \  \_|\ \ \  \\\  \ \  \___|\ \  \\\  \ \  \____\ \  \_\\ \          
 *       \ \_______\ \_______\ \_______\ \__\    \ \_______\ \_______\ \_______\         
 *        \|_______|\|_______|\|_______|\|__|     \|_______|\|_______|\|_______|         
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *     ___  __    ________  ________  ___       _______   ________                       
 *    |\  \|\  \ |\   __  \|\   ____\|\  \     |\  ___ \ |\   __  \                      
 *    \ \  \/  /|\ \  \|\  \ \  \___|\ \  \    \ \   __/|\ \  \|\  \                     
 *     \ \   ___  \ \  \\\  \ \  \  __\ \  \    \ \  \_|/_\ \   _  _\                    
 *      \ \  \\ \  \ \  \\\  \ \  \|\  \ \  \____\ \  \_|\ \ \  \\  \|                   
 *       \ \__\\ \__\ \_______\ \_______\ \_______\ \_______\ \__\\ _\                   
 *        \|__| \|__|\|_______|\|_______|\|_______|\|_______|\|__|\|__|                  
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *     ________  ________  ________  _______   ________          ________  ________      
 *    |\   __  \|\   __  \|\   ____\|\  ___ \ |\   ___ \        |\   __  \|\   ___  \    
 *    \ \  \|\ /\ \  \|\  \ \  \___|\ \   __/|\ \  \_|\ \       \ \  \|\  \ \  \\ \  \   
 *     \ \   __  \ \   __  \ \_____  \ \  \_|/_\ \  \ \\ \       \ \  \\\  \ \  \\ \  \  
 *      \ \  \|\  \ \  \ \  \|____|\  \ \  \_|\ \ \  \_\\ \       \ \  \\\  \ \  \\ \  \ 
 *       \ \_______\ \__\ \__\____\_\  \ \_______\ \_______\       \ \_______\ \__\\ \__\
 *        \|_______|\|__|\|__|\_________\|_______|\|_______|        \|_______|\|__| \|__|
 *                           \|_________|                                                
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *     ________  ________  _______           ________    _____   ________                
 *    |\   __  \|\   ____\|\  ___ \         |\   __  \  / __  \ |\_____  \               
 *    \ \  \|\  \ \  \___|\ \   __/|        \ \  \|\  \|\/_|\  \ \|___/  /|              
 *     \ \  \\\  \ \  \    \ \  \_|/__       \ \  \\\  \|/ \ \  \    /  / /              
 *      \ \  \\\  \ \  \____\ \  \_|\ \       \ \  \\\  \ __\ \  \  /  / /               
 *       \ \_______\ \_______\ \_______\       \ \_______\\__\ \__\/__/ /                
 *        \|_______|\|_______|\|_______|        \|_______\|__|\|__||__|/                 
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *        ___  ________  ________  _______                                               
 *       |\  \|\   ____\|\   __  \|\  ___ \                                              
 *       \ \  \ \  \___|\ \  \|\  \ \   __/|                                             
 *     __ \ \  \ \  \    \ \   __  \ \  \_|/__                                           
 *    |\  \\_\  \ \  \____\ \  \ \  \ \  \_|\ \                                          
 *    \ \________\ \_______\ \__\ \__\ \_______\                                         
 *     \|________|\|_______|\|__|\|__|\|_______|                                         
 *                                                                                       
 *    2016
 */
package at.smartpart.transfer;

import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.FileOutputStream;
import java.io.FileWriter;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.List;

import com.ptc.pfc.pfcGlobal.pfcGlobal;
import com.ptc.pfc.pfcSession.Session;

import at.smartpart.Workbench;


public class FetchSolids {


	Connection conn = null;
	
	public FetchSolids() {

		CADConnection cadcon = new CADConnection();
		conn = cadcon.getConnected();
	}
	
	
	public boolean queryForSolid(List<String> list) throws SQLException, IOException {
		

		String select ="";
		
		for( String item : list) { //@todo split list in 2 lists (asm|prt) and fetch all in 2 queries
			if(item.contains("asm")){
				
				select = "select * from fingerprint.asms WHERE filename = '" + item + "' ORDER BY version DESC LIMIT 1;";
				
			}else{
				select = "select * from fingerprint.prts WHERE filename = '" + item + "' ORDER BY version DESC LIMIT 1;";
				
			}
			
			System.out.println(select);
			
			Statement st = null;
			st = conn.createStatement();

			ResultSet rs = st.executeQuery(select);

			while (rs.next()) {
				int id = rs.getInt("id");
				String fileName = rs.getString("filename");
				
				if(item.contains("asm"))
				{
					int version = rs.getInt("version");
					if(version==0)version++;
					String path = Workbench.getWorkingDir() + "\\" + fileName + "." + version;
					File file = new File(path);
				    FileOutputStream fos = new FileOutputStream(file);
				    byte[] buffer = new byte[1];
				    InputStream is = rs.getBinaryStream("container");
				    while (is.read(buffer) > 0) {
				    	fos.write(buffer);
				    }
				    fos.close();
				    }
				else
				{
					int version = rs.getInt("version");
					if(version==0)version++;
					String path = Workbench.getWorkingDir() + "\\" + fileName + "." + version;
					File file = new File(path);
				    FileOutputStream fos = new FileOutputStream(file);
				    byte[] buffer = new byte[1];
				    InputStream is = rs.getBinaryStream("solid");
				    while (is.read(buffer) > 0) {
				    	fos.write(buffer);
				    }
				    fos.close();
				    }
			}
			rs.close();


		}
		try { 
			if (conn != null) conn.close();
			} catch (SQLException se) {
		  se.printStackTrace();
		  }
		return true;
	}


private static String getStringFromInputStream(InputStream is) {

	BufferedReader br = null;
	StringBuilder sb = new StringBuilder();

	String line;
	try {

		br = new BufferedReader(new InputStreamReader(is));
		while ((line = br.readLine()) != null) {
			sb.append(line);
		}

	} catch (IOException e) {
		e.printStackTrace();
	} finally {
		if (br != null) {
			try {
				br.close();
			} catch (IOException e) {
				e.printStackTrace();
			}
		}
	}

	System.out.println(sb.toString());
	return sb.toString();

}

	public void close() {

		try {
			conn.close();
		} catch (SQLException e) {

			e.printStackTrace();
			System.out.println(e.toString());
		}

	}


	
}
