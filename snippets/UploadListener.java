/***
 *              _____                    _____                    _____                    _____             _____                    _____                    _____                    _____             _____                        
 *             /\    \                  /\    \                  /\    \                  /\    \           /\    \                  /\    \                  /\    \                  /\    \           /\    \                       
 *            /::\    \                /::\____\                /::\    \                /::\    \         /::\    \                /::\    \                /::\    \                /::\    \         /::\    \                      
 *           /::::\    \              /::::|   |               /::::\    \              /::::\    \        \:::\    \              /::::\    \              /::::\    \              /::::\    \        \:::\    \                     
 *          /::::::\    \            /:::::|   |              /::::::\    \            /::::::\    \        \:::\    \            /::::::\    \            /::::::\    \            /::::::\    \        \:::\    \                    
 *         /:::/\:::\    \          /::::::|   |             /:::/\:::\    \          /:::/\:::\    \        \:::\    \          /:::/\:::\    \          /:::/\:::\    \          /:::/\:::\    \        \:::\    \                   
 *        /:::/__\:::\    \        /:::/|::|   |            /:::/__\:::\    \        /:::/__\:::\    \        \:::\    \        /:::/__\:::\    \        /:::/__\:::\    \        /:::/__\:::\    \        \:::\    \                  
 *        \:::\   \:::\    \      /:::/ |::|   |           /::::\   \:::\    \      /::::\   \:::\    \       /::::\    \      /::::\   \:::\    \      /::::\   \:::\    \      /::::\   \:::\    \       /::::\    \                 
 *      ___\:::\   \:::\    \    /:::/  |::|___|______    /::::::\   \:::\    \    /::::::\   \:::\    \     /::::::\    \    /::::::\   \:::\    \    /::::::\   \:::\    \    /::::::\   \:::\    \     /::::::\    \                
 *     /\   \:::\   \:::\    \  /:::/   |::::::::\    \  /:::/\:::\   \:::\    \  /:::/\:::\   \:::\____\   /:::/\:::\    \  /:::/\:::\   \:::\____\  /:::/\:::\   \:::\    \  /:::/\:::\   \:::\____\   /:::/\:::\    \               
 *    /::\   \:::\   \:::\____\/:::/    |:::::::::\____\/:::/  \:::\   \:::\____\/:::/  \:::\   \:::|    | /:::/  \:::\____\/:::/  \:::\   \:::|    |/:::/  \:::\   \:::\____\/:::/  \:::\   \:::|    | /:::/  \:::\____\              
 *    \:::\   \:::\   \::/    /\::/    / ~~~~~/:::/    /\::/    \:::\  /:::/    /\::/   |::::\  /:::|____|/:::/    \::/    /\::/    \:::\  /:::|____|\::/    \:::\  /:::/    /\::/   |::::\  /:::|____|/:::/    \::/    /              
 *     \:::\   \:::\   \/____/  \/____/      /:::/    /  \/____/ \:::\/:::/    /  \/____|:::::\/:::/    //:::/    / \/____/  \/_____/\:::\/:::/    /  \/____/ \:::\/:::/    /  \/____|:::::\/:::/    //:::/    / \/____/               
 *      \:::\   \:::\    \                  /:::/    /            \::::::/    /         |:::::::::/    //:::/    /                    \::::::/    /            \::::::/    /         |:::::::::/    //:::/    /                        
 *       \:::\   \:::\____\                /:::/    /              \::::/    /          |::|\::::/    //:::/    /                      \::::/    /              \::::/    /          |::|\::::/    //:::/    /                         
 *        \:::\  /:::/    /               /:::/    /               /:::/    /           |::| \::/____/ \::/    /                        \::/____/               /:::/    /           |::| \::/____/ \::/    /                          
 *         \:::\/:::/    /               /:::/    /               /:::/    /            |::|  ~|        \/____/                          ~~                    /:::/    /            |::|  ~|        \/____/                           
 *          \::::::/    /               /:::/    /               /:::/    /             |::|   |                                                              /:::/    /             |::|   |                                          
 *           \::::/    /               /:::/    /               /:::/    /              \::|   |                                                             /:::/    /              \::|   |                                          
 *            \::/    /                \::/    /                \::/    /                \:|   |                                                             \::/    /                \:|   |                                          
 *             \/____/                  \/____/                  \/____/                  \|___|                                                              \/____/                  \|___|                                          
 *                                                                                                                                                                                                                                     
 *                                                                                                                                                                                                                                     
 *                                                                                                                                                                                                                                     
 *     
 *     ________      ___    ___                                                          
 *    |\   __  \    |\  \  /  /|                                                         
 *    \ \  \|\ /_   \ \  \/  / /                                                         
 *     \ \   __  \   \ \    / /                                                          
 *      \ \  \|\  \   \/  /  /                                                           
 *       \ \_______\__/  / /                                                             
 *        \|_______|\___/ /                                                              
 *                 \|___|/                                                               
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *     ________ ________  ___  _______   ________  ________  ___  ________  ___  ___     
 *    |\  _____\\   __  \|\  \|\  ___ \ |\   ___ \|\   __  \|\  \|\   ____\|\  \|\  \    
 *    \ \  \__/\ \  \|\  \ \  \ \   __/|\ \  \_|\ \ \  \|\  \ \  \ \  \___|\ \  \\\  \   
 *     \ \   __\\ \   _  _\ \  \ \  \_|/_\ \  \ \\ \ \   _  _\ \  \ \  \    \ \   __  \  
 *      \ \  \_| \ \  \\  \\ \  \ \  \_|\ \ \  \_\\ \ \  \\  \\ \  \ \  \____\ \  \ \  \ 
 *       \ \__\   \ \__\\ _\\ \__\ \_______\ \_______\ \__\\ _\\ \__\ \_______\ \__\ \__\
 *        \|__|    \|__|\|__|\|__|\|_______|\|_______|\|__|\|__|\|__|\|_______|\|__|\|__|
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *     ________  _______       ___    ___ _______   ________                             
 *    |\   ____\|\  ___ \     |\  \  /  /|\  ___ \ |\   __  \                            
 *    \ \  \___|\ \   __/|    \ \  \/  / | \   __/|\ \  \|\  \                           
 *     \ \  \  __\ \  \_|/__   \ \    / / \ \  \_|/_\ \   _  _\                          
 *      \ \  \|\  \ \  \_|\ \   \/  /  /   \ \  \_|\ \ \  \\  \|                         
 *       \ \_______\ \_______\__/  / /      \ \_______\ \__\\ _\                         
 *        \|_______|\|_______|\___/ /        \|_______|\|__|\|__|                        
 *                           \|___|/                                                     
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *     ___       _______   ________  ________  ________  ___       ________              
 *    |\  \     |\  ___ \ |\   __  \|\   __  \|\   __  \|\  \     |\   ___ \             
 *    \ \  \    \ \   __/|\ \  \|\  \ \  \|\  \ \  \|\  \ \  \    \ \  \_|\ \            
 *     \ \  \    \ \  \_|/_\ \  \\\  \ \   ____\ \  \\\  \ \  \    \ \  \ \\ \           
 *      \ \  \____\ \  \_|\ \ \  \\\  \ \  \___|\ \  \\\  \ \  \____\ \  \_\\ \          
 *       \ \_______\ \_______\ \_______\ \__\    \ \_______\ \_______\ \_______\         
 *        \|_______|\|_______|\|_______|\|__|     \|_______|\|_______|\|_______|         
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *     ___  __    ________  ________  ___       _______   ________                       
 *    |\  \|\  \ |\   __  \|\   ____\|\  \     |\  ___ \ |\   __  \                      
 *    \ \  \/  /|\ \  \|\  \ \  \___|\ \  \    \ \   __/|\ \  \|\  \                     
 *     \ \   ___  \ \  \\\  \ \  \  __\ \  \    \ \  \_|/_\ \   _  _\                    
 *      \ \  \\ \  \ \  \\\  \ \  \|\  \ \  \____\ \  \_|\ \ \  \\  \|                   
 *       \ \__\\ \__\ \_______\ \_______\ \_______\ \_______\ \__\\ _\                   
 *        \|__| \|__|\|_______|\|_______|\|_______|\|_______|\|__|\|__|                  
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *     ________  ________  ________  _______   ________          ________  ________      
 *    |\   __  \|\   __  \|\   ____\|\  ___ \ |\   ___ \        |\   __  \|\   ___  \    
 *    \ \  \|\ /\ \  \|\  \ \  \___|\ \   __/|\ \  \_|\ \       \ \  \|\  \ \  \\ \  \   
 *     \ \   __  \ \   __  \ \_____  \ \  \_|/_\ \  \ \\ \       \ \  \\\  \ \  \\ \  \  
 *      \ \  \|\  \ \  \ \  \|____|\  \ \  \_|\ \ \  \_\\ \       \ \  \\\  \ \  \\ \  \ 
 *       \ \_______\ \__\ \__\____\_\  \ \_______\ \_______\       \ \_______\ \__\\ \__\
 *        \|_______|\|__|\|__|\_________\|_______|\|_______|        \|_______|\|__| \|__|
 *                           \|_________|                                                
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *     ________  ________  _______           ________    _____   ________                
 *    |\   __  \|\   ____\|\  ___ \         |\   __  \  / __  \ |\_____  \               
 *    \ \  \|\  \ \  \___|\ \   __/|        \ \  \|\  \|\/_|\  \ \|___/  /|              
 *     \ \  \\\  \ \  \    \ \  \_|/__       \ \  \\\  \|/ \ \  \    /  / /              
 *      \ \  \\\  \ \  \____\ \  \_|\ \       \ \  \\\  \ __\ \  \  /  / /               
 *       \ \_______\ \_______\ \_______\       \ \_______\\__\ \__\/__/ /                
 *        \|_______|\|_______|\|_______|        \|_______\|__|\|__||__|/                 
 *                                                                                       
 *                                                                                       
 *                                                                                       
 *        ___  ________  ________  _______                                               
 *       |\  \|\   ____\|\   __  \|\  ___ \                                              
 *       \ \  \ \  \___|\ \  \|\  \ \   __/|                                             
 *     __ \ \  \ \  \    \ \   __  \ \  \_|/__                                           
 *    |\  \\_\  \ \  \____\ \  \ \  \ \  \_|\ \                                          
 *    \ \________\ \_______\ \__\ \__\ \_______\                                         
 *     \|________|\|_______|\|__|\|__|\|_______|                                         
 *                                                                                       
 *    2016
 */
package at.smartpart.listeners;

import java.awt.BorderLayout;
import java.awt.Dimension;
import java.awt.Font;
import java.awt.event.ActionListener;
import java.util.ArrayList;
import java.util.Collections;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

import javax.swing.BoxLayout;
import javax.swing.JButton;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTable;
import javax.swing.JTree;
import javax.swing.SwingUtilities;
import javax.swing.table.DefaultTableModel;
import javax.swing.tree.DefaultMutableTreeNode;
import javax.swing.tree.TreeModel;

import org.apache.commons.collections4.ListUtils;

import com.ptc.cipjava.jxthrowable;
import com.ptc.pfc.pfcCommand.DefaultUICommandActionListener;
import com.ptc.pfc.pfcComponentFeat.ComponentFeat;
import com.ptc.pfc.pfcDrawing.Drawing;
import com.ptc.pfc.pfcModel.Model;
import com.ptc.pfc.pfcModel.ModelDescriptor;
import com.ptc.pfc.pfcModel.ModelDescriptors;
import com.ptc.pfc.pfcModel.ModelType;
import com.ptc.pfc.pfcSession.Session;
import com.ptc.pfc.pfcView.View;

import at.smartpart.Workbench;
import at.smartpart.beans.MyTreeNode;
import at.smartpart.beans.PRT;
import at.smartpart.beans.VersionComparator;
import at.smartpart.resolve.MyTreeTraversal;
import at.smartpart.resolve.SubTreeTraversal;
import at.smartpart.resolve.TreeTraversal;
import at.smartpart.transfer.FetchVersionString;
import at.smartpart.transfer.UploadData;

public class UploadListener extends DefaultUICommandActionListener {

	private Session session;
	private List<PRT> cleanedUlList = new ArrayList<PRT>();
	static List<String> toUpload = new ArrayList<String>();
	Object[][] data = new Object[2][2];
	DefaultTableModel tModel;
	boolean firsRunt = true;
	protected JFrame membersDialog = new JFrame();
	JPanel panel = new JPanel();
	JTable table;
	private boolean firstRun = true;
	JButton btnConfirm;
	List<PRT> curVersionsTable ;
	JScrollPane jsp;

	public UploadListener(Session wfSession) {
		this.session = wfSession;
	}

	@Override
	public void OnCommand() throws jxthrowable {
		
		Dimension dim = new Dimension(1000, 600);
		panel.removeAll();
		com.ptc.pfc.pfcDisplay.Font ptcFont  = session.GetDefaultFont();
		String defFontName =ptcFont.GetName();
		Font font = new Font(defFontName,1, 25);
		
		
		Model model = session.GetCurrentModel();
		
		if(model.GetType()==ModelType.MDL_DRAWING) {
			
			List<PRT> drwMembers = new ArrayList<PRT>();
		Drawing drawing = (Drawing)model;
		ModelDescriptors decModels = drawing.ListDeclaredModels();
		
		for (int index = 0; index < decModels.getarraysize(); index++) {

			ModelDescriptor description = decModels.get(index);

			Model mod = session.GetModelFromDescr(description);
			
			drwMembers.add(new PRT(mod.GetFileName(),Integer.parseInt(mod.GetReleaseLevel())));

		}
		
		PRT uploadDRW = new PRT(model.GetFileName(),Integer.parseInt(model.GetVersionStamp()),drwMembers);
		
		for( PRT member : drwMembers) {
			Model mdl = session.GetModelFromFileName(member.getFileName());
			
			calcUpload(mdl);
			
		}
		
		if (model != null && (model.GetType()==ModelType.MDL_ASSEMBLY | model.GetType()==ModelType.MDL_PART)) {
		
			calcUpload(model);
			
			jsp.setVisible(true);
			jsp.repaint();
			jsp.invalidate();
			panel.setLayout(new BoxLayout(panel, BoxLayout.Y_AXIS));
			JPanel hpanel = new JPanel();
			hpanel.setLayout(new BoxLayout(hpanel, BoxLayout.X_AXIS));
			panel.add(jsp);// , BorderLayout.CENTER);
			panel.add(hpanel);
			table.setVisible(true);
			hpanel.add(btnConfirm);
			//hpanel.add(btnSearch);
			panel.setSize(990, 590);
			panel.setVisible(true);
			membersDialog.getContentPane().add(panel);
			membersDialog.repaint();
			membersDialog.setSize(dim);
			membersDialog.setAlwaysOnTop(true);
			membersDialog.setVisible(true);

			
		
		} else 	{
			System.out.println("No solid in session");
		}
		
			
		}




	private void calcUpload( Model model) {

		MyTreeTraversal traverse = new MyTreeTraversal(model, session);
		List<PRT> uploadList = traverse.getPRTList();
		
		traverse.createBom();

		StringBuilder sb = new StringBuilder();
		sb.append("Upload these Candidates :  \n");
		
		toUpload.clear();
		cleanedUlList.clear();

		for (int i = 0; i < uploadList.size(); i++) {

			String prt = uploadList.get(i).getFileName();
			String asm = uploadList.get(i).getFileName();

			if (!toUpload.contains(asm)) {
				toUpload.add(asm);
				cleanedUlList.add(uploadList.get(i));
			} else if (!toUpload.contains(prt)) {
				toUpload.add(prt);
				cleanedUlList.add(uploadList.get(i));
			}

		}

		for (int i = 0; i < toUpload.size(); i++) {
			sb.append("#:" + i + toUpload.get(i) + "\n");
		}

		FetchVersionString fetchVersion = new FetchVersionString();
		List<PRT> curVersions = fetchVersion.fetch(toUpload);

		List<PRT> notFoundInDB = ListUtils.subtract(cleanedUlList, curVersions);

		for (int i = 0; i < notFoundInDB.size(); i++) {
			notFoundInDB.get(i).setCurVersion(-1);
			notFoundInDB.get(i).setNextVersion(0);
		}
		// Zusammensetzten der Listen :

		curVersionsTable = new ArrayList<PRT>();
		 
		 curVersionsTable.addAll(notFoundInDB);
		 curVersionsTable.addAll(curVersions);
		 
	Collections.sort(curVersionsTable, new VersionComparator());

	final Map<String, PRT> map = new LinkedHashMap<String, PRT> ();
	int k = 0;
		for(PRT cadPart : curVersionsTable) {
			System.out.println(""+ k);
			map.put(cadPart.getFileName(), cadPart);
			k++;
		}
	curVersionsTable.clear();
	curVersionsTable.addAll(map.values());
	
	Collections.sort(curVersionsTable, new VersionComparator());
	
		
		Object[] colums = { "Filename", "local Version", "current Version", "new Version" };
		data = new Object[curVersionsTable.size()][2];

		

		for (int i = 0; i < curVersionsTable.size(); i++) {

			PRT cadPart = curVersionsTable.get(i);

			System.out.println("in loop " + i + " " + cadPart.getFileName());

			Object[] rowData = { cadPart.getFileName(), cadPart.getLocalVersion(), cadPart.getCurDbVersion(),
					cadPart.getNextVersion() };

			data[i] = rowData;

		}

		System.out.println(data.toString());
		
		//panel = new JPanel();
		
		if( firstRun ){
		tModel = new DefaultTableModel(data,colums);
		table = new JTable(tModel);
		}
		if( !firstRun ){
			DefaultTableModel model2 =(DefaultTableModel) table.getModel();
			model2.setDataVector(data, colums);
			table = new JTable(model2);
		}
		
		firstRun = false;
		
		tModel.fireTableDataChanged();
		//tModel.setDataVector(data, colums);
		
		
		table.setFont(font);
		table.setRowHeight(font.getSize()+10);
		
		table.setAutoCreateColumnsFromModel(true);
		//table.tableChanged(null);
		
		jsp = new JScrollPane(table);
		table.invalidate();
		table.setSize(990,590);
		table.repaint();
		jsp.invalidate();
		jsp.repaint();

		//JPanel tPanel = traverse.getTreePanel();
		//JFrame membersDialog = new JFrame();

		//panel = traverse.getTreePanel();

		Map<String, DefaultMutableTreeNode> knots = traverse.getResultMap();

		SubTreeTraversal subTrav = new SubTreeTraversal(session, knots);
		Map<String, JTree> subAsms = subTrav.getResultMap();

	

		Workbench.setWorkDir(session.GetCurrentDirectory());

		String lblCaption = sb.toString();

		System.out.println(lblCaption);

		JLabel lblMembers = new JLabel(lblCaption);
		lblMembers.setVisible(true);
		lblMembers.setSize(200, 200);

		btnConfirm = new JButton("Confirm");
		btnConfirm.addActionListener(new ActionListener() {
			public void actionPerformed(java.awt.event.ActionEvent e) {

				new Thread() {
					public void run() {
						
						new UploadData(subAsms, map);

						try {
							fadeOut();
						} catch (jxthrowable e) {
						
							e.printStackTrace();
							System.out.println(e.toString());
						}
						
						traverse.clearAll();
						subTrav.clearAll();
						curVersionsTable.clear();
						
					}
		
				}.start();

			}
		});
		
	}


	public static List<String> getList() {
		return toUpload;
	}

	void fadeOut() throws jxthrowable {

		Runnable edt = new Runnable() {
			public void run() {
				membersDialog.setVisible(false);
				
				clearArray(data);
				
				membersDialog.removeAll();
				
				//membersDialog.repaint();				
				
			}
		};
		SwingUtilities.invokeLater(edt);

	}
	
	private void clearArray(Object[][] data2) {
		
		for(int i = 0; i<data2.length; i++){
			for(int j = 0; j<data2.length; j++){
				data2[i][j] = "";
			}
		}

}
}